[["index.html", "Notes Chapter 1 Welcome", " Notes Laurie Platt 2021-03-01 Chapter 1 Welcome This is a place for ad-hoc notes, mainly to do with scripting and mainly R scripts. It’s somewhere to store lessons learnt and examples. A resource to remind yourself if you return to something after a while away from it, or to smooth your path a little if it’s something new. There are many excellent online resources that these notes will point to and will not attempt to replace. Overtime some notes may mature into package vignettes or become accepted as good practice and included in the Methods Manual. Hopefully, others from the Performance &amp; Intelligence Team, or elsewhere in Sheffield City Council, will contribute to these notes. However, currently it’s just one person and is biased to one person’s recent experience: ETL, geocoding and spatial analysis. Notes about modelling and visualisations are lacking. As well as the contributors and content, the purpose and scope is open to change. I hope you find the notes useful. "],["github.html", "Chapter 2 Version Control &amp; GitHub 2.1 Why version control? 2.2 GIT 2.3 GitHub 2.4 Git &amp; RStudio", " Chapter 2 Version Control &amp; GitHub You don’t have to be familiar with version control, Git and GitHub to make use of these notes or the contents of the scc-pi repositories. If you’re new to scripting and R, visualisations or using R Markdown are better starting points than version control. These notes are public, but to contribute i.e. edit them, you need a GitHub account and to be granted permission by an owner of scc-pi (try Laurie first, but Giles and Anne could help too). Then you can edit directly in GitHub via your browser. You also need a GitHub account and permission to access one of our private repositories, but not for our public repositories, to download a file, copy &amp; paste code, or source and use a function: # Load functions for Sheffield areas from a public scc-pi repository source(&quot;https://raw.githubusercontent.com/scc-pi/functions/main/ShefAreas.R&quot;) # Call one of our Sheffield area functions that returns LSOA codes shef_lsoa_codes() %&gt;% head(5) %&gt;% #only display the first 5 records knitr::kable() #display them in a nice table ## [1] &quot;Table&quot; LSOA11CD LSOA11NM E01008124 Sheffield 012F E01008125 Sheffield 009G E01007917 Sheffield 071B E01033273 Sheffield 042F E01007967 Sheffield 045B Try raising an issue if you spot a problem, have a suggestion or a question. 2.1 Why version control? When scripting I take a backup of a file, so if the changes I make break what I’ve previously done, I can revert to the previous version. If I’m collating contributions to a document from different people I might use their initials to indicate who’s made contributions in what version e.g. “BI_Principles-GR.docx” and “BI_Principles-NM.docx”. These are both examples of manual version control. When we talk about version control and scripting we typically mean a version control system. A tool that assists with tracking changes to files over time and by different people. Such systems also usually include reasons for the changes, and file, or rather version, comparison functionality. So a version control system is a backup/audit trail/collaboration thing. 2.2 GIT Git is an open-source distributed version control system for tracking changes in source code during software development. 2.3 GitHub GitHub is a product that offers Git-based source control repositories. Other products also offer Git-based repositories, such as GitLab, BitBucket, and Azure DevOps. Our scc-pi GitHub organisation is a free account. It has had no approval as such. If using it proves successful we will need to discuss approval with BCIS. 2.3.1 Security &amp; data protection Assuming that GitHub.com is hosted in the US, it will not meet our data protection obligations. Either way, we’ve not checked compliance with Information Governance, so storing PID (Person Identifiable Data), or anything commercially confidential or politically sensitive, on GitHub.com is currently a no no. As an additional precaution, any projects related to such information should be held in a private repository. Microsoft own GitHub and GitHub Enterprise Server is the on-premises deployment of GitHub.com that could be hosted on our own Azure environment. 2.3.2 Forking and pull requests GitHub forking and pull requests are common workflows when collaborating on a repository. TODO - hopefully we’ll have more to add on this if we get to collaborating on a repository 2.3.3 Other features GitHub now allows private repositories on free organisation accounts, but not all GitHub features are available. The evolution of a repository is captured by commits i.e. the changes to files in the repository. However, the original issue, ideas or discussion surrounding a commit is captured in a GitHub issue. You can link a commit to an issue by including the issue number prefixed by # in the commit message. I’ve used a GitHub project to organise the our private C19Surveillance repository as a kanban board. However, a project is not restricted to issues or a single repository. GitHub pages and actions have been used to [publish these notes]4.4.1. There are also other GitHub features to explore. 2.4 Git &amp; RStudio TODO - SSH - Happy Git with R "],["r.html", "Chapter 3 R &amp; RStudio 3.1 Why script? 3.2 Style guide 3.3 RStudio security &amp; data protection 3.4 Getting started 3.5 RStudio tips", " Chapter 3 R &amp; RStudio 3.1 Why script? I initially started scripting in Python to automate some spatial analysis tasks, but soon realised that reproducibility was the main advantage. Iterating, improving a process incrementally and at the end verifying the results by re-running the script. There’s an element of self-documentation with scripting, so it’s easier to return to a scripted task after a bit of time away from it, or pick up a scripted task from a colleague. However, in-line comments and adherence to a style guide make a big difference to just how easy it is. Version control and collaboration are also easier with scripting than GUI tools. Scripting is not always better than using GUI tools. There’s a good reason that more people use Mac OS and Windows than Unix Bash. Scripting or GUI tools is a horses for courses question, and some GUI workflow tools (e.g. FME, Simul8 and ModelBuilder in ArcGIS) sit somewhere in the middle. 3.2 Style guide Something I need to pay more attention to is following the tidyverse style guide, which benefits from supporting tools and familiarity via tidyverse package documentation. Scripting to the same style guide makes collaboration easier. Which style guide is less important than collaborators scripting to the same style guide. 3.3 RStudio security &amp; data protection TODO Preferences Renviron 3.4 Getting started I’m not going to provide advice on getting started, other than signposting to the RStudio beginners page: RStudio Education - Beginners 3.5 RStudio tips TODO - Write settings Pipe addin Document outline and headings Shortcuts "],["rmd.html", "Chapter 4 R Markdown 4.1 R Markdown vs Markdown 4.2 Child markdown iteration 4.3 Notebooks 4.4 Bookdown 4.5 Further resources 4.6 R Markdown tips", " Chapter 4 R Markdown 4.1 R Markdown vs Markdown TODO 4.2 Child markdown iteration TODO - example based on C19 UoS example - not a prominent technique because the demand for such reports has largely been superseded by browser base dashboards such as those provided via Power BI or Shiny 4.3 Notebooks TODO - technical vs data exploration - don’t add to github 4.4 Bookdown These notes are written using the bookdown package , which was built on top of R Markdown and knitr. Each Rmd file contains one and only one chapter, and a chapter is defined by the first-level heading #. 4.4.1 Publishing These notes are published on GitHub Pages with GitHub Actions. A GitHub Action has been configured to start when there’s a push to the master branch. The Action renders the Rmd files in the master branch to HTML and then deploys the HTML files as a static website to a branch called gh-pages. Alternatives to using GitHub Actions include Travis and Jekyll. I used the steps outlined in the following blog post: How to publish bookdown projects with GitHub Actions on GitHub Pages. However, I did a lot of the git bash commands manually and there were a couple of fixes I made to the deploy_bookdown.yaml file: 1. Under … uses: Cecilapp/GitHub-Pages-deploy@master … I added … with: build_dir: _book/ email: ${{ secrets.EMAIL }} 2. I used GITHUB_TOKEN rather than GH_PAT, as per a recent change to GitHub-Pages-deploy. 4.5 Further resources Authoring Books with R Markdown by Yihui Xie is the definitive resource for bookdown. 4.6 R Markdown tips 4.6.1 Markdown visual editor The RStudio v1.4 release includes a visual editor for markdown, which makes it more like using MS Word: 4.6.2 Chunk named setup Naming a code block setup means that after you restart RStudio and execute any code in the middle of your markdown document, the setup block will run first. For example, to make sure your libraries are loaded first: ```{r, setup, message = FALSE, warning = FALSE} # Packages library(tidyverse) ``` "],["api.html", "Chapter 5 APIs 5.1 RESTful APIs 5.2 Wrappers", " Chapter 5 APIs 5.1 RESTful APIs TODO - Foundation for Council services 5.2 Wrappers TODO "],["python.html", "Chapter 6 Python 6.1 Reticulate 6.2 ArcGIS", " Chapter 6 Python 6.1 Reticulate TODO reticulate R package. 6.2 ArcGIS The Council’s ArcGIS software from ESRI has a much stronger integration with Python than R. ESRI’s Python integration with ArcGIS is via two main packages. The arcgis package is what we’re going to use here to work with the Council’s web based GIS infrastructure. The arcpy package would be used to leverage the ArcGIS desktop functionality. The distinction between web and desktop for arcgis and arcpy packages respectively is an oversimplification, but it serves a purpose. It’s worth noting that the integration between the two packages isn’t as seamless as you might expect. To use the arcpy or arcgis packages we first need to specify the ArcGIS Python environment TODO 6.2.1 ArcPy TODO 6.2.2 ArcGIS API TODO "],["gis.html", "Chapter 7 GIS 7.1 Features 7.2 Simple Features 7.3 Coordinates &amp; projections 7.4 ArcGIS 7.5 Rasters", " Chapter 7 GIS 7.1 Features The term “feature” is useful to distinguish a record as “spatial”. By “spatial” we mean it has a point, a line or a polygon. A point is a pair of coordinates, a line a minimum of two pairs of coordinates and polygons. Something to keep an eye out for is MULTIPOINT, multi-part polygons etc. This is a single record, a single feature, but it has more than one point, line or polygon. For example, Sheffield secondary school features might be MULTIPOINT so that the feature for King Edward VII school can have one point for the Lower School near Crosspool, and another point for the Upper School in Broomhill. 7.2 Simple Features TODO 7.3 Coordinates &amp; projections TODO 7.4 ArcGIS TODO 7.5 Rasters TODO "],["geocoding.html", "Chapter 8 Postcodes &amp; Addresses 8.1 UPRN 8.2 Postcodes 8.3 Addresses", " Chapter 8 Postcodes &amp; Addresses A common use case in our work is to do some spatial analysis on a dataset with addresses. For example, produce a map of certain incidents over the last year, or summarise the number of incidents by Ward. 8.1 UPRN TODO 8.2 Postcodes If there’s no UPRN, getting a location via the postcode is usually the easiest option. It’s not as accurate as a UPRN or a full address, but often it’s accurate enough for what’s required. Below is an example of using our add_pcd_vars() function that builds on the PostcodesioR package, which itself is a wrapper for the postcodes.io API. You pass it a data frame with a postcode column and it returns the data frame with new columns based on the postcode. # Create a data frame with some example records df &lt;- tribble( ~name, ~postcode, &quot;Bob Johnson&quot;, &quot;S1 2HH&quot;, &quot;Chris Wilder&quot;, &quot;S2 4SU&quot;, &quot;Neil Thompson&quot;, &quot;S6 1SW&quot; ) # Load the function we need source(&quot;https://raw.githubusercontent.com/scc-pi/functions/main/Addresses.R&quot;) # Add postcode related columns to our data frame add_pcd_vars(df, pcd_name = &quot;postcode&quot;, .admin_district = FALSE, .lat_long = TRUE, other_vars = c(&quot;admin_ward&quot;, &quot;msoa_code&quot;)) %&gt;% knitr::kable() #display them in a nice table name postcode longitude latitude admin_ward msoa_code Bob Johnson S1 2HH -1.470006 53.38038 City E02006843 Chris Wilder S2 4SU -1.470512 53.36986 City E02001652 Neil Thompson S6 1SW -1.500859 53.41084 Hillsborough E02001627 admin_district can be used to answer the questions: Is it the postcode invalid? Is the postcode in Sheffield? You can anticipate values of NA and Sheffield respectively if the answers are yes. These are common questions so the function has an .admin_district argument. Needing the coordinates of the postcode centroid is also common, so the function also has a .lat_long argument that if TRUE returns both a latitude column and a longitude column. TODO: link to sf example &amp; area stats Other columns are added by including their name in a character vector passed with the other_vars function argument. For example, other_vars=c(\"ccg_code\",\"lsoa_code\"). The list of valid other_vars is defined at docs.ropensci.org/PostcodesioR/#examples. The pcd_name function argument is used to specify the name of the data frame’s postcode column when it isn’t postcode. For example, pcd_name=\"pupil_pcode\". Sometimes, the postcode in a dataset is not included as a separate column, but is at the end of a combined address column. Depending on the format and quality of the combined address column you could extract the postcode like this: # Create a data frame with some example records df &lt;- tribble( ~name, ~address, &quot;Bob Johnson&quot;, &quot;Pinstone St, Sheffield City Centre, Sheffield S1 2HH&quot;, &quot;Chris Wilder&quot;, &quot;Bramall Ln, Highfield, Sheffield S2 4SU&quot;, &quot;Neil Thompson&quot;, &quot;76 Penistone Rd N, Sheffield S6 1SW&quot; ) # Extract the postcode from the address into a separate column mutate(df, postcode = word(address, -2, -1, sep = &quot;[:space:]&quot;)) %&gt;% knitr::kable() name address postcode Bob Johnson Pinstone St, Sheffield City Centre, Sheffield S1 2HH S1 2HH Chris Wilder Bramall Ln, Highfield, Sheffield S2 4SU S2 4SU Neil Thompson 76 Penistone Rd N, Sheffield S6 1SW S6 1SW 8.2.1 PAS Postcode Lookup PAS, the Performance &amp; Analysis Service in the People Porfolio, maintains a postcode lookup table that performs the same role as the add_pcd_vars() function. TODO: Does it also include Sheffield specific variables e.g. which of the 100 neighbourhoods is the postcode in? 8.2.2 Split postcodes TODO 8.3 Addresses TODO - Portal LLPG Cascade Locator - OS Places ESRI integration "],["public-data.html", "Chapter 9 Public Data Sources 9.1 Office of National Statistics 9.2 Ordnance Survey", " Chapter 9 Public Data Sources 9.1 Office of National Statistics TODO 9.1.1 CRM TODO 9.1.2 NOMIS TODO 9.1.3 Open Geography Portal TODO 9.2 Ordnance Survey TODO 9.2.1 OS Data Hub TODO "],["databases.html", "Chapter 10 Databases 10.1 Corporate data warehouse 10.2 Corporate spatial database 10.3 SQLite 10.4 Further resources", " Chapter 10 Databases 10.1 Corporate data warehouse 10.1.1 OSCAR TODO 10.2 Corporate spatial database TODO 10.3 SQLite Access to an SQLite database is controlled by permissions on the folder where it is stored. Unlike other databases, you do not create users who are authenticated by the database, and you do not grant privileges on specific datasets to other users. SQLite is also different from other databases in that fields are not assigned specific data types and data type definitions are not strictly enforced. Instead, SQLite uses storage classes in which values of different data types can be stored. In particular, date types are handled differently. ArcGIS handles SQLite dates without needing any special attention, but reading dates from SQLite in to R or Power BI needs attention. For example, by using the JD() function from the insol package: # Convert dates we&#39;ve read from a SQLite database mutate(date = JD(date, inverse = TRUE), week_end = JD(week_end, inverse = TRUE)) 10.3.1 SpatiaLite SpatiaLite extends SQLite to support spatial data. The RSQLite package includes the driver for SpatiaLite. Robin Lovelace has a chapter on spatial databases in his book Geocomputation with R. After testing different options, SpatiaLite is the best file based database for access to spatial data via tools such as R and Power BI without the complication of ArcGIS licenses, but it also provides reliable access for ArcGIS. So far I’ve only tested SpatiaLite databases created in ArcGIS 10.4 Further resources Databases using R from RStudio "],["references.html", "References", " References "]]
